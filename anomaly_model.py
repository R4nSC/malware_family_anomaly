from sklearn.svm import OneClassSVM
import torch.nn as nn
from torch.autograd import Variable

from config import *


def anomaly_detection_model(features_model, data_loaders):
    # AlexNetの最終層の次元数を変更
    alx_lt = list(features_model.classifier)
    features_model.classifier = nn.Sequential(alx_lt[0], alx_lt[1], alx_lt[2], alx_lt[3], alx_lt[4], alx_lt[5])

    OCSVM = OneClassSVM(nu=0.01, kernel="rbf", gamma=0.00025)

    print("OCSVM train phase")
    print('-' * 10)

    with torch.no_grad():
        features_list = []
        for data in data_loaders['train']:
            images, labels = data

            if USE_GPU:
                images = Variable(images.cuda())
                labels = Variable(labels.cuda())
            else:
                images, labels = Variable(images), Variable(labels)

            feature = features_model(images)
            feature = feature.cpu()
            features_list.append(feature)

        train_features = torch.cat(features_list, dim=0)
        print(train_features.size())

        OCSVM.fit(train_features)

    with torch.no_grad():
        features_list = []
        for data in data_loaders['test']:
            images, labels = data

            if USE_GPU:
                images = Variable(images.cuda())
                labels = Variable(labels.cuda())
            else:
                images, labels = Variable(images), Variable(labels)

            feature = features_model(images)
            feature = feature.cpu()
            features_list.append(feature)

        test_features = torch.cat(features_list, dim=0)
        print(test_features.size())

        pred_test = OCSVM.predict(test_features)
        print(pred_test)

